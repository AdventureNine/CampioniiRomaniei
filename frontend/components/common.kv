#:import hex kivy.utils.get_color_from_hex
#:import AppColors frontend.utils.colors.AppColors

<IconButton@ButtonBehavior+Image>:
    size_hint: None, None
    fit_mode: "contain"

# --- WIDGET TIMER (NOU) ---
<TimerDisplay@BoxLayout>:
    size_hint: None, None
    size: 130, 50
    padding: [10, 5]
    spacing: 5
    opacity: 1 if app.timer_text else 0

    canvas.before:
        Color:
            rgba: (0, 0, 0, 0.2)
        RoundedRectangle:
            pos: self.pos
            size: self.size
            radius: [15,]

    # Iconița de ceas
    Image:
        source: root.timer_image
        size_hint: None, 1
        width: 30
        fit_mode: "contain"

    # Textul timpului
    Label:
        text: app.timer_text
        font_size: '20sp'
        bold: True
        color: hex('#FFEB3B') # Galben
        valign: 'middle'
        halign: 'left'
        text_size: self.width, None

# --- WIDGET SCOR ---
<ScoreDisplay>:
    size_hint: None, None
    size: 130, 50
    pos_hint: {'center_y': 0.5}
    padding: [15, 5]

    canvas:
        Color:
            rgba: (0, 0, 0, 0.2)
        RoundedRectangle:
            pos: self.pos
            size: self.size
            radius: [15,]

    Label:
        text: str(app.score) if hasattr(app, 'score') else "0"
        font_size: '20sp'
        bold: True
        color: hex('#FFEB3B')
        valign: 'middle'


    Image:
        source: root.coin_image
        size_hint: 1, 1

# --- HEADER STANDARD ---
<StandardHeader>:
    size_hint_y: None
    height: 80

    canvas.before:
        Color:
            rgba: AppColors.PRIMARY
        Rectangle:
            pos: self.pos
            size: self.size

    # --- 1. BUTONUL DE ÎNAPOI (Săgeată) ---
    IconButton:
        source: root.back_image

        size: 200, 200
        pos_hint: {'x': 0.05, 'center_y': 0.5}

        opacity: 1 if root.show_back_button else 0
        disabled: not root.show_back_button

        on_release: app.clouds.change_screen(root.back_screen) if hasattr(app, 'clouds') else None

    # --- 2. TITLUL (CENTRAT PERFECT) ---
    Label:
        text: root.title
        font_size: '26sp'
        bold: True
        color: AppColors.WHITE

        halign: 'center'
        valign: 'middle'
        text_size: self.width, None

        pos_hint: {'center_x': 0.7, 'center_y': 0.5}

    # --- 3. ZONA DREAPTĂ (Timer + Scor) ---
    BoxLayout:
        size_hint: None, 1
        width: 280 # Mărim puțin lățimea containerului
        spacing: 15
        pos_hint: {'right': 0.98, 'center_y': 0.5}
        orientation: 'horizontal'

        # Spacer
        Widget:
            size_hint_x: 1

        # 1. Componenta Timer (Nouă)
        TimerDisplay:

        # 2. Componenta Scor (Existentă)
        ScoreDisplay:

# --- POPUP FEEDBACK (Fără Mascotă) ---
<FeedbackPopup>:
    BoxLayout:
        orientation: 'vertical'
        padding: 30
        spacing: 20
        canvas.before:
            Color:
                rgba: AppColors.SUCCESS if root.type == 'success' else (AppColors.ERROR if root.type == 'fail' else AppColors.INFO)
            RoundedRectangle:
                pos: self.pos
                size: self.size
                radius: [20,]

        Label:
            text: root.title_text
            font_size: '36sp'
            bold: True
            size_hint_y: 0.3
            color: AppColors.WHITE

        Label:
            text: root.message_text
            font_size: '24sp'
            halign: 'center'
            valign: 'middle'
            text_size: self.width - 40, None
            color: AppColors.WHITE

        Button:
            text: root.button_text
            size_hint: None, None
            size: 200, 60
            pos_hint: {'center_x': 0.5}
            background_normal: ''
            background_color: (1, 1, 1, 0.3)
            font_size: '22sp'
            bold: True
            on_release: root.dismiss()

# --- BUTON RĂSPUNS QUIZ ---
<AnswerButton>:
    background_normal: ''
    background_color: AppColors.BACKGROUND
    color: AppColors.TEXT_PRIMARY
    font_size: '20sp'
    bold: True
    text_size: self.width - 20, None
    halign: 'center'
    valign: 'middle'
    canvas.before:
        Color:
            rgba: self.background_color
        RoundedRectangle:
            pos: self.pos
            size: self.size
            radius: [15,]
        Color:
            rgba: AppColors.PRIMARY
        Line:
            rounded_rectangle: (self.x, self.y, self.width, self.height, 15)
            width: 2
    background_down: ''

# --- CERC NIVEL (1, 2, 3...) ---
<LevelCircle@Button>:
    size_hint: None, None
    size: 90, 90
    font_size: '28sp'
    bold: True
    background_normal: ''
    background_disabled_normal: ''
    # Dacă e activ: Albastru deschis. Dacă e dezactivat: Gri
    background_color: hex('#29B6F6') if not self.disabled else hex('#BDBDBD')
    color: hex('#FFFFFF')
    canvas.before:
        Color:
            rgba: self.background_color
        Ellipse:
            pos: self.pos
            size: self.size